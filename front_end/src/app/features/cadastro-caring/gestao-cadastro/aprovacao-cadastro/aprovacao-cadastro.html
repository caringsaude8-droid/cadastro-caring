<app-page-header title="Aprova√ß√£o de Cadastro" subtitle="Revisar solicita√ß√µes de inclus√£o, altera√ß√£o e exclus√£o"></app-page-header>

<div class="aprovacao-container">
  <div class="toast" *ngIf="showToastMessage">{{ toastMessage }}</div>
  <div class="filters caring-card">
    <input class="input" [(ngModel)]="termo" placeholder="Pesquisar por identificador, descri√ß√£o, solicitante ou data">
    <select class="form-select" [(ngModel)]="filtroTipo">
      <option value="">Todos os tipos</option>
      <option value="inclusao">Inclus√£o</option>
      <option value="alteracao">Altera√ß√£o</option>
      <option value="exclusao">Exclus√£o</option>
    </select>
    <select class="form-select" [(ngModel)]="filtroStatus">
      <option value="">Todos os status</option>
      <option value="pendente">Pendente</option>
      <option value="aguardando">Aguardando</option>
      <option value="concluida">Conclu√≠da</option>
    </select>
    <button class="btn btn-primary" (click)="atualizarLista()" [disabled]="carregando">
      <i class="fas fa-sync" [class.fa-spin]="carregando"></i>
      Atualizar
    </button>
  </div>

  <div class="caring-card">
    <table class="table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Entidade</th>
          <th>Identificador</th>
          <th>Solicitante</th>
          <th>Descri√ß√£o</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of lista">
          <td>{{ s.data | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ s.tipo }}</td>
          <td>{{ s.entidade }}</td>
          <td>{{ s.identificador }}</td>
          <td>{{ s.solicitante }} <span *ngIf="s.codigoEmpresa">({{ s.codigoEmpresa }})</span></td>
          <td>{{ s.descricao }}</td>
          <td>
            <span class="badge" [class]="s.status === 'pendente' ? 'status-pendente' : (s.status === 'aguardando' ? 'status-aguardando' : 'status-concluida')">{{ s.status }}</span>
          </td>
          <td class="actions">
            <button class="btn btn-icon" title="Detalhes" (click)="openDetails(s)">üîé</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Detalhes da Solicita√ß√£o -->
<div *ngIf="showDetails" class="modal-backdrop" (click)="closeDetails()"></div>
<div *ngIf="showDetails" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Detalhes da Solicita√ß√£o</h3>
    <div style="display:flex; gap:8px; align-items:center;">
      
      <button class="btn btn-icon" *ngIf="selected?.tipo === 'inclusao'" title="Ver dados da inclus√£o" (click)="openInclusaoDetails()">üîé</button>
      <button class="modal-close" (click)="closeDetails()">√ó</button>
    </div>
  </div>
  <div class="modal-body" *ngIf="selected as d">
    <div class="detail-grid">
      <!-- Data normalizada para ISO no servi√ßo/componente para evitar NG02100 -->
      <div class="item"><span class="label">Data:</span><span class="value">{{ d.data | date:'dd/MM/yyyy HH:mm' }}</span></div>
      <div class="item"><span class="label">Tipo:</span><span class="value">{{ d.tipo }}</span></div>
      <div class="item"><span class="label">Entidade:</span><span class="value">{{ d.entidade }}</span></div>
      <div class="item"><span class="label">Identificador:</span><span class="value">{{ d.identificador }}</span></div>
      <div class="item"><span class="label">Solicitante:</span><span class="value">{{ d.solicitante }} <span *ngIf="d.codigoEmpresa">({{ d.codigoEmpresa }})</span></span></div>
      <div class="item"><span class="label">Descri√ß√£o:</span><span class="value">{{ d.descricao }}</span></div>
      <!-- Observa√ß√£o do solicitante ser√° exibida apenas no hist√≥rico abaixo -->
      <div class="item"><span class="label">Status atual:</span><span class="value">{{ d.status }}</span></div>
    </div>

    <div class="section-subtitle">Hist√≥rico</div>
    <div class="history-list">
      <div class="history-item" *ngFor="let h of historicoCompleto">
        <!-- Hist√≥rico com dataOperacao normalizada (dd/MM ‚Üí ISO) -->
        <span class="history-date">{{ h.dataOperacao | date:'dd/MM/yyyy HH:mm' }}</span>
        <span class="history-status">{{ h.usuarioNome }}</span>
        <span class="history-observacao">‚Äî {{ h.valorNovo }}</span>
      </div>
    </div>
    <div class="history-list" *ngIf="historicoCompleto.length === 0">
      <div class="history-item">
        <span class="history-status">Sem hist√≥rico dispon√≠vel</span>
      </div>
    </div>

    <div class="section-subtitle" *ngIf="anexosSelecionado.length > 0">Anexos enviados pelo solicitante</div>
    <div class="anexos-list" *ngIf="anexosSelecionado.length > 0">
      <div class="anexo" *ngFor="let a of anexosSelecionado; let i = index">
        <div class="anexo-info">
          <span class="tipo">{{ a.tipo }}</span>
          <span class="nome">{{ a.nome }}</span>
          <span class="size">{{ a.size / 1024 | number:'1.0-1' }} KB</span>
        </div>
        <div class="anexo-actions">
          <button class="btn btn-secondary btn-sm" (click)="baixarAnexo(i)"><i class="icon-download"></i> Baixar</button>
        </div>
      </div>
    </div>

    <div class="section-subtitle" *ngIf="d.status === 'pendente'">A√ß√£o</div>
    <textarea *ngIf="d.status === 'pendente'" class="input" rows="3" [(ngModel)]="observacaoAprovacao" placeholder="Observa√ß√£o da aprova√ß√£o (opcional)"></textarea>
    <div class="action-grid" *ngIf="d.status === 'pendente'">
      <button class="btn btn-primary btn-sm" (click)="aceitarSelecionado()" [disabled]="!podeAprovarSelecionado()"><i class="icon-check-circle"></i> Aceitar</button>
      <button class="btn btn-secondary btn-sm" (click)="negarSelecionado()"><i class="icon-refresh"></i> Negar</button>
    </div>

    <div class="section-subtitle" *ngIf="d.status === 'concluida'">Situa√ß√£o</div>
    <div class="concluida-banner" *ngIf="d.status === 'concluida'">Solicita√ß√£o conclu√≠da. Nenhuma a√ß√£o adicional permitida.</div>

    
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="closeDetails()">Fechar</button>
  </div>
</div>

<!-- Modal interno: Detalhes da Inclus√£o -->
<div *ngIf="showInclusaoDetails" class="modal-backdrop" (click)="closeInclusaoDetails()"></div>
<div *ngIf="showInclusaoDetails" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Detalhes da Inclus√£o</h3>
    <button class="modal-close" (click)="closeInclusaoDetails()">√ó</button>
  </div>
  <div class="modal-body">
    <div class="detail-grid" *ngIf="dadosDetalhes">
      <!-- Detalhes da inclus√£o; benRelacaoDep define titular ('00') ou dependente -->
      <div class="item"><span class="label">Rela√ß√£o Dep.:</span><span class="value">{{ dadosDetalhes.benRelacaoDep }}</span></div>
      <div class="item" *ngIf="dadosDetalhes.benRelacaoDep === '00'"><span class="label">Titular:</span><span class="value">{{ dadosDetalhes.benCpf }}</span></div>
      <div class="item" *ngIf="dadosDetalhes.benRelacaoDep !== '00'"><span class="label">Titular:</span><span class="value">{{ dadosDetalhes.benTitularCpf }}</span></div>
      <div class="item"><span class="label">Nome:</span><span class="value">{{ dadosDetalhes.benNomeSegurado }}</span></div>
      <div class="item" *ngIf="dadosDetalhes.benTitularId"><span class="label">ID Titular:</span><span class="value">{{ dadosDetalhes.benTitularId }}</span></div>
      <div class="item"><span class="label">CPF:</span><span class="value">{{ dadosDetalhes.benCpf }}</span></div>
      <div class="item"><span class="label">Nascimento:</span><span class="value">{{ dadosDetalhes.benDtaNasc }}</span></div>
      <div class="item"><span class="label">Sexo:</span><span class="value">{{ dadosDetalhes.benSexo }}</span></div>
      <div class="item"><span class="label">Estado Civil:</span><span class="value">{{ dadosDetalhes.benEstCivil }}</span></div>
      <div class="item"><span class="label">M√£e:</span><span class="value">{{ dadosDetalhes.benNomeDaMae }}</span></div>
      <div class="item"><span class="label">Endere√ßo:</span><span class="value">{{ dadosDetalhes.benEndereco }}</span></div>
      <div class="item"><span class="label">N√∫mero:</span><span class="value">{{ dadosDetalhes.benNumero }}</span></div>
      <div class="item"><span class="label">Complemento:</span><span class="value">{{ dadosDetalhes.benComplemento }}</span></div>
      <div class="item"><span class="label">Bairro:</span><span class="value">{{ dadosDetalhes.benBairro }}</span></div>
      <div class="item"><span class="label">Cidade/UF:</span><span class="value">{{ dadosDetalhes.benCidade }} / {{ dadosDetalhes.benUf }}</span></div>
      <div class="item"><span class="label">CEP:</span><span class="value">{{ dadosDetalhes.benCep }}</span></div>
      <div class="item"><span class="label">Matr√≠cula:</span><span class="value">{{ dadosDetalhes.benMatricula }}</span></div>
      <div class="item"><span class="label">Celular:</span><span class="value">{{ dadosDetalhes.benDddCel }}</span></div>
      <div class="item"><span class="label">E-mail:</span><span class="value">{{ dadosDetalhes.benEmail }}</span></div>
      <div class="item"><span class="label">Plano:</span><span class="value">{{ dadosDetalhes.benPlanoProd }}</span></div>
      <div class="item"><span class="label">Admiss√£o:</span><span class="value">{{ dadosDetalhes.benAdmissao }}</span></div>
      <div class="item"><span class="label">Data Inclus√£o:</span><span class="value">{{ dadosDetalhes.benDtaInclusao }}</span></div>
      <div class="item"><span class="label">Status:</span><span class="value">{{ dadosDetalhes.benStatus }}</span></div>
      <div class="item"><span class="label">C√≥digo do Cart√£o:</span><span class="value">{{ dadosDetalhes.benCodCartao }}</span></div>
      <div class="item"><span class="label">C√≥digo Unimed Seg:</span><span class="value">{{ dadosDetalhes.benCodUnimedSeg }}</span></div>
      <div class="item"><span class="label">C√≥digo da Carterinha:</span><span class="value">{{ (dadosDetalhes.benCodUnimedSeg || '') + (dadosDetalhes.benCodCartao || '') }}</span></div>
    </div>
  </div>
  <div class="modal-footer">
    <!-- Bot√£o de fallback para completar dependentes do lote (s√≥ aparece quando necess√°rio) -->
    <button class="btn btn-primary btn-sm" *ngIf="podeForcarCompletar()" (click)="forcarCompletar()">Completar dependentes (lote)</button>
    <button class="btn btn-secondary btn-sm" (click)="closeInclusaoDetails()">Fechar</button>
  </div>
</div>

<!-- Modal de Aprova√ß√£o de Inclus√£o -->
<div class="modal" [class.show]="showApprovalModal" *ngIf="showApprovalModal">
  <div class="modal-content modal-medium">
    <div class="modal-header">
      <h3 class="modal-title">Aprova√ß√£o de Inclus√£o</h3>
      <button class="modal-close" (click)="closeApprovalModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p><strong>Solicita√ß√£o:</strong> {{ approvalSolicitacao?.descricao }}</p>
      <p><strong>CPF:</strong> {{ approvalSolicitacao?.identificador }}</p>
      
      <div class="form-row">
        <div class="form-group half">
          <label>C√≥digo do Cart√£o</label>
          <input type="text" class="input" [(ngModel)]="dadosAprovacao.benCodCartao" placeholder="Digite o c√≥digo do cart√£o">
        </div>
        <div class="form-group half">
          <label>C√≥digo Unimed Seg</label>
          <input type="text" class="input" [(ngModel)]="dadosAprovacao.benCodUnimedSeg" placeholder="Digite o c√≥digo Unimed">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Observa√ß√£o da Aprova√ß√£o</label>
          <textarea class="input" rows="3" [(ngModel)]="observacaoAprovacao" placeholder="Mensagem ao solicitante (opcional)"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" (click)="confirmarAprovacao()" [disabled]="!podeAprovarConfirmacao()">Aprovar</button>
      <button class="btn btn-secondary" (click)="closeApprovalModal()">Cancelar</button>
    </div>
  </div>
</div>
<div class="modal" [class.show]="showRejectModal" *ngIf="showRejectModal">
  <div class="modal-content modal-small">
    <div class="modal-header">
      <h3 class="modal-title">Confirmar Nega√ß√£o</h3>
      <button class="modal-close" (click)="closeRejectModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p><strong>Solicita√ß√£o:</strong> {{ rejectSolicitacao?.descricao }}</p>
      <p><strong>CPF:</strong> {{ rejectSolicitacao?.identificador }}</p>
      <div class="form-row">
        <div class="form-group">
          <label>Observa√ß√£o da Nega√ß√£o</label>
          <textarea class="input" rows="3" [(ngModel)]="observacaoAprovacao" placeholder="Explique o motivo (opcional)"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeRejectModal()">Revisar</button>
      <button class="btn btn-primary danger" (click)="confirmarNegacao()">Confirmar Nega√ß√£o</button>
    </div>
  </div>
</div>
<!-- Modal interno: Detalhes do Benefici√°rio -->
<div *ngIf="showBenefDetails" class="modal-backdrop" (click)="closeBenefDetails()"></div>
<div *ngIf="showBenefDetails" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Detalhes do Benefici√°rio</h3>
    <button class="modal-close" (click)="closeBenefDetails()">√ó</button>
  </div>
  <div class="modal-body" *ngIf="benefDetalhes as r">
    <div class="detail-grid">
      <div class="item"><span class="label">Nome:</span><span class="value">{{ r.nome }}</span></div>
      <div class="item"><span class="label">CPF:</span><span class="value">{{ r.cpf }}</span></div>
      <div class="item"><span class="label">Nascimento:</span><span class="value">{{ r.nascimento }}</span></div>
      <div class="item"><span class="label">Status:</span><span class="value">{{ r.benStatus }}</span></div>
      <div class="item"><span class="label">Matr√≠cula:</span><span class="value">{{ r.matricula }}</span></div>
      <div class="item"><span class="label">Endere√ßo:</span><span class="value">{{ r.endereco }}</span></div>
      <div class="item"><span class="label">N√∫mero:</span><span class="value">{{ r.numero }}</span></div>
      <div class="item"><span class="label">Complemento:</span><span class="value">{{ r.complemento }}</span></div>
      <div class="item"><span class="label">Bairro:</span><span class="value">{{ r.bairro }}</span></div>
      <div class="item"><span class="label">CEP:</span><span class="value">{{ r.cep }}</span></div>
      <div class="item"><span class="label">Celular:</span><span class="value">{{ r.celular }}</span></div>
      <div class="item"><span class="label">E-mail:</span><span class="value">{{ r.email }}</span></div>
      <div class="item"><span class="label">Plano:</span><span class="value">{{ r.planoProd }}</span></div>
      <div class="item"><span class="label">Admiss√£o:</span><span class="value">{{ r.admissao }}</span></div>
      <div class="item"><span class="label">C√≥digo Unimed Seg:</span><span class="value">{{ r.benCodUnimedSeg }}</span></div>
      <div class="item"><span class="label">C√≥digo do Cart√£o:</span><span class="value">{{ r.benCodCartao }}</span></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="closeBenefDetails()">Fechar</button>
  </div>
</div>
