<app-page-header title="Aprova√ß√£o de Cadastro" subtitle="Revisar solicita√ß√µes de inclus√£o, altera√ß√£o e exclus√£o"></app-page-header>

<div class="aprovacao-container">
  <div class="filters caring-card">
    <input class="input" [(ngModel)]="termo" placeholder="Pesquisar por identificador, descri√ß√£o ou solicitante">
    <select class="form-select" [(ngModel)]="filtroTipo">
      <option value="">Todos os tipos</option>
      <option value="inclusao">Inclus√£o</option>
      <option value="alteracao">Altera√ß√£o</option>
      <option value="exclusao">Exclus√£o</option>
    </select>
    <select class="form-select" [(ngModel)]="filtroStatus">
      <option value="">Todos os status</option>
      <option value="pendente">Pendente</option>
      <option value="aguardando">Aguardando</option>
      <option value="concluida">Conclu√≠da</option>
    </select>
  </div>

  <div class="caring-card">
    <table class="table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Entidade</th>
          <th>Identificador</th>
          <th>Solicitante</th>
          <th>Descri√ß√£o</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of lista">
          <td>{{ s.data | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ s.tipo }}</td>
          <td>{{ s.entidade }}</td>
          <td>{{ s.identificador }}</td>
          <td>{{ s.solicitante }} <span *ngIf="s.codigoEmpresa">({{ s.codigoEmpresa }})</span></td>
          <td>{{ s.descricao }}</td>
          <td>
            <span class="badge" [class]="s.status === 'pendente' ? 'status-pendente' : (s.status === 'aguardando' ? 'status-aguardando' : 'status-concluida')">{{ s.status }}</span>
          </td>
          <td class="actions">
            <button class="btn btn-icon" title="Detalhes" (click)="openDetails(s)">üîé</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Detalhes da Solicita√ß√£o -->
<div *ngIf="showDetails" class="modal-backdrop" (click)="closeDetails()"></div>
<div *ngIf="showDetails" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Detalhes da Solicita√ß√£o</h3>
    <button class="modal-close" (click)="closeDetails()">√ó</button>
  </div>
  <div class="modal-body" *ngIf="selected as d">
    <div class="detail-grid">
      <div class="item"><span class="label">Data:</span><span class="value">{{ d.data | date:'dd/MM/yyyy HH:mm' }}</span></div>
      <div class="item"><span class="label">Tipo:</span><span class="value">{{ d.tipo }}</span></div>
      <div class="item"><span class="label">Entidade:</span><span class="value">{{ d.entidade }}</span></div>
      <div class="item"><span class="label">Identificador:</span><span class="value">{{ d.identificador }}</span></div>
      <div class="item"><span class="label">Solicitante:</span><span class="value">{{ d.solicitante }} <span *ngIf="d.codigoEmpresa">({{ d.codigoEmpresa }})</span></span></div>
      <div class="item"><span class="label">Descri√ß√£o:</span><span class="value">{{ d.descricao }}</span></div>
      <div class="item" *ngIf="d.observacao"><span class="label">Observa√ß√£o da solicita√ß√£o:</span><span class="value">{{ d.observacao }}</span></div>
      <div class="item"><span class="label">Status atual:</span><span class="value">{{ d.status }}</span></div>
    </div>

    <div class="section-subtitle">Hist√≥rico</div>
    <div class="history-list" *ngIf="d.historico?.length">
      <div class="history-item" *ngFor="let h of d.historico" [ngClass]="{'solicitante': h.status === 'pendente' && (h.observacao || '').includes('Ajustes do solicitante')}">
        <span class="history-date">{{ h.data | date:'dd/MM/yyyy HH:mm' }}</span>
        <span class="history-status">{{ h.status }}</span>
        <span class="history-observacao" *ngIf="h.observacao">‚Äî {{ h.observacao }}</span>
      </div>
    </div>

    <div class="section-subtitle" *ngIf="anexosSelecionado.length > 0">Anexos enviados pelo solicitante</div>
    <div class="anexos-list" *ngIf="anexosSelecionado.length > 0">
      <div class="anexo" *ngFor="let a of anexosSelecionado; let i = index">
        <div class="anexo-info">
          <span class="tipo">{{ a.tipo }}</span>
          <span class="nome">{{ a.nome }}</span>
          <span class="size">{{ a.size / 1024 | number:'1.0-1' }} KB</span>
        </div>
        <div class="anexo-actions">
          <button class="btn btn-secondary btn-sm" (click)="baixarAnexo(i)"><i class="icon-download"></i> Baixar</button>
        </div>
      </div>
    </div>

    <div class="section-subtitle" *ngIf="d.status !== 'concluida'">A√ß√£o</div>
    <div class="action-grid" *ngIf="d.status !== 'concluida'">
      <button class="btn btn-primary btn-sm" (click)="aceitarSelecionado()"><i class="icon-check-circle"></i> Aceitar</button>
      <button class="btn btn-secondary btn-sm" (click)="negarSelecionado()"><i class="icon-refresh"></i> Negar</button>
    </div>

    <div class="section-subtitle" *ngIf="d.status === 'concluida'">Situa√ß√£o</div>
    <div class="concluida-banner" *ngIf="d.status === 'concluida'">Solicita√ß√£o conclu√≠da. Nenhuma a√ß√£o adicional permitida.</div>

    <div class="section-subtitle" *ngIf="d.status !== 'concluida'">Mensagem ao solicitante (em caso de negativa)</div>
    <textarea *ngIf="d.status !== 'concluida'" class="input" rows="3" [(ngModel)]="motivoNegacao" placeholder="Explique o que falta para aceita√ß√£o"></textarea>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="closeDetails()">Fechar</button>
  </div>
</div>
