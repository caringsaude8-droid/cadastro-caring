<div class="page-container">

  <app-page-header 
    [title]="'Cadastro Caring ‚Äî Inclus√£o de Benefici√°rio'" 
    [subtitle]="'Preencha os dados obrigat√≥rios marcados com *'" 
    [icon]="'users'">
  </app-page-header>

  <!-- Informa√ß√µes da Empresa -->
  <div class="empresa-info" *ngIf="empresaSelecionada">
    <div class="empresa-card">
      <div class="empresa-icon">üè¢</div>
      <div class="empresa-details">
        <h3>{{empresaSelecionada.nome}}</h3>
        <p>CNPJ: {{empresaSelecionada.cnpj}}</p>
        <span class="empresa-codigo">C√≥digo: {{empresaSelecionada.codigoEmpresa}}</span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-message" *ngIf="loading">
    <div class="spinner"></div>
    <span>Carregando informa√ß√µes...</span>
  </div>

  <!-- Toast Notification -->
  <div class="toast-container" *ngIf="showToastMessage">
    <div class="toast" [ngClass]="'toast-' + toastType">
      <div class="toast-icon">
        <span *ngIf="toastType === 'success'">‚úì</span>
        <span *ngIf="toastType === 'error'">‚úó</span>
        <span *ngIf="toastType === 'warning'">‚ö†</span>
        <span *ngIf="toastType === 'info'">‚Ñπ</span>
      </div>
      <div class="toast-content">
        <div class="toast-title">{{toastTitle}}</div>
        <div class="toast-message">{{toastMessage}}</div>
      </div>
      <button class="toast-close" (click)="showToastMessage = false">√ó</button>
    </div>
  </div>

  <div class="form-card">
    <form class="benef-form" (ngSubmit)="salvar()">
      <!-- ...existing code... -->
      <div class="correcao-banner" *ngIf="isModoCorrecao">
        <strong>Modo Corre√ß√£o:</strong> Voc√™ est√° corrigindo uma solicita√ß√£o rejeitada. Revise os dados e salve para reenviar.
      </div>
      <div class="section-title-bar">Dados do Benefici√°rio</div>
      <div class="form-row">
        <div class="form-group third">
          <label>Rela√ß√£o Dep. *</label>
          <select class="form-select" [(ngModel)]="form.relacaoDep" name="relacaoDep" required (change)="onRelacaoChanged()">
            <option value="">Selecione</option>
            <option *ngFor="let r of relacionamentos" [value]="r.value">{{r.label}}</option>
          </select>
        </div>
        <div class="form-group third"></div>
        <div class="form-group third" *ngIf="form.relacaoDep && form.relacaoDep !== 'titular'">
          <div class="selection-card">
            <div class="selection-header">
              <span>CPF do Titular *</span>
              <button type="button" class="btn-search" (click)="buscarTitular()" [disabled]="buscandoTitular">
                <span *ngIf="!buscandoTitular">üîç Buscar</span>
                <span *ngIf="buscandoTitular">‚è≥ Buscando...</span>
              </button>
            </div>
            <div class="selection-body">
              <div class="selection-row">
                <ui-input 
                  [(ngModel)]="cpfTitular" 
                  name="cpfTitular" 
                  placeholder="000.000.000-00" 
                  [onlyDigits]="true" [maxlength]="11">
                </ui-input>
              </div>
              <div class="selection-row" *ngIf="titularEncontrado">
                <div class="selection-result titular-encontrado">
                  ‚úì {{titularEncontrado.nome}} ({{titularEncontrado.cpf}})
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group third">
          <label>Data Nascimento *</label>
          <ui-input type="date" [(ngModel)]="form.dataNascimento" name="dataNascimento" [required]="true"></ui-input>
        </div>
        <div class="form-group third">
          <label>Sexo *</label>
          <select class="form-select" [(ngModel)]="form.sexo" name="sexo" required>
            <option value="">Selecione</option>
            <option *ngFor="let s of sexos" [value]="s.value">{{s.label}}</option>
          </select>
        </div>
        <div class="form-group third">
          <label>Estado Civil *</label>
          <select class="form-select" [(ngModel)]="form.estadoCivil" name="estadoCivil" required>
            <option value="">Selecione</option>
            <option *ngFor="let e of estadosCivis" [value]="e.value">{{e.label}}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group third">
          <label>Data Inclus√£o *</label>
          <ui-input type="date" [(ngModel)]="form.dataInclusaoExclusao" name="dataInclusaoExclusao" [required]="true"></ui-input>
        </div>
        <div class="form-group third">
          <label>Plano/ Prod *</label>
          <select class="form-select" [(ngModel)]="form.planoProd" name="planoProd" required>
            <option value="">Selecione</option>
            <ng-container *ngFor="let p of planos">
              <option *ngIf="isPlanoVisivel(p.value)" [value]="p.value">{{p.label}}</option>
            </ng-container>
          </select>
        </div>
        <div class="form-group third">
          <label>Nome Segurado *</label>
          <ui-input [(ngModel)]="form.nomeSegurado" name="nomeSegurado" [required]="true"></ui-input>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group third">
          <label>CPF *</label>
          <ui-input [(ngModel)]="form.cpf" name="cpf" [required]="true" placeholder="000.000.000-00" (valueChange)="onCpfInput($event)" [onlyDigits]="true" [maxlength]="11"></ui-input>
          <div class="form-error" *ngIf="cpfDuplicado" style="color:#dc2626; font-size:0.85rem; margin-top:6px;">CPF j√° cadastrado para esta empresa</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group third">
          <label>Admiss√£o *</label>
          <ui-input type="date" [(ngModel)]="form.admissao" name="admissao" [required]="true"></ui-input>
        </div>
        <div class="form-group third">
          <label>Nome da M√£e *</label>
          <ui-input [(ngModel)]="form.nomeMae" name="nomeMae" [required]="true"></ui-input>
        </div>
        <div class="form-group third">
          <label>Matr√≠cula *</label>
          <ui-input [(ngModel)]="form.matricula" name="matricula" [required]="true" [onlyDigits]="true"></ui-input>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group third"></div>
        <div class="form-group third"></div>
        <div class="form-group third"></div>
      </div>

      <div class="section-title-bar">Endere√ßo</div>

      <!-- Campo CEP com busca autom√°tica -->
      <div class="form-row">
        <div class="form-group third">
          <label>CEP *</label>
          <div class="cep-input-container">
            <ui-input 
              [(ngModel)]="form.cep" 
              name="cep" 
              placeholder="00000-000" 
              [required]="true"
              [onlyDigits]="true" [maxlength]="8"
              (ngModelChange)="buscarCep()"
              [class.error]="cepInvalido">
            </ui-input>
            <div class="cep-status">
              <span *ngIf="isLoadingCep" class="loading-cep">üîÑ Buscando...</span>
              <span *ngIf="enderecoCarregado" class="success-cep">‚úÖ Endere√ßo encontrado</span>
              <span *ngIf="cepInvalido" class="error-cep">‚ùå CEP inv√°lido</span>
            </div>
          </div>
        </div>
        <div class="form-group third">
          <label>Cidade *</label>
          <ui-input [(ngModel)]="form.cidade" name="cidade" [required]="true" [readonly]="enderecoCarregado"></ui-input>
        </div>
        <div class="form-group third">
          <label>UF *</label>
          <ui-input [(ngModel)]="form.uf" name="uf" [required]="true" [readonly]="enderecoCarregado"></ui-input>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group third">
          <label>Endere√ßo *</label>
          <ui-input [(ngModel)]="form.endereco" name="endereco" [required]="true" [readonly]="enderecoCarregado"></ui-input>
        </div>
        <div class="form-group third">
          <label>Bairro *</label>
          <ui-input [(ngModel)]="form.bairro" name="bairro" [required]="true" [readonly]="enderecoCarregado"></ui-input>
        </div>
        <div class="form-group third">
          <label>N√∫mero *</label>
          <ui-input [(ngModel)]="form.numero" name="numero" [required]="true" [onlyDigits]="true"></ui-input>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group third">
          <label>Complemento</label>
          <ui-input [(ngModel)]="form.complemento" name="complemento"></ui-input>
        </div>
        <div class="form-group third"></div>
      </div>

      

      <div class="form-row">
        <div class="form-group third"></div>
        <div class="form-group third"></div>
      </div>

      <div class="section-title-bar">Contato</div>
      <div class="form-row">
        <div class="form-group third">
          <label>Celular (com DDD) *</label>
          <ui-input [(ngModel)]="form.celular" name="celular" [required]="true" placeholder="(11) 99999-9999" [onlyDigits]="true" [maxlength]="11"></ui-input>
        </div>
        <div class="form-group third">
          <label>Receber comunica√ß√£o por email? *</label>
          <select class="form-select" [(ngModel)]="form.receberComunicacaoEmail" name="receberComunicacaoEmail" required>
            <option value="nao">N√£o</option>
            <option value="sim">Sim</option>
          </select>
        </div>
        <div class="form-group third"></div>
      </div>

      <div class="form-row">
        <div class="form-group third">
          <label>E-mail *</label>
          <ui-input type="email" [(ngModel)]="form.email" name="email" [required]="true"></ui-input>
        </div>
        <div class="form-group third"></div>
        <div class="form-group third"></div>
      </div>


      <div class="section-title-bar">Dados Complementares</div>
      <div class="form-row">
        <div class="form-group third">
          <label>Data Casamento</label>
          <ui-input type="date" [(ngModel)]="form.dataCasamento" name="dataCasamento"></ui-input>
        </div>
        <div class="form-group third">
          <label>Indicador Pessoa Trans</label>
          <select class="form-select" [(ngModel)]="form.indicadorPessoaTrans" name="indicadorPessoaTrans">
            <option value="nao">N√£o</option>
            <option value="sim">Sim</option>
          </select>
        </div>
        <div class="form-group third">
          <label>Nome Social</label>
          <ui-input [(ngModel)]="form.nomeSocial" name="nomeSocial"></ui-input>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group third">
          <label>Identidade de G√™nero</label>
          <select class="form-select" [(ngModel)]="form.identidadeGenero" name="identidadeGenero">
            <option value="">Selecione</option>
            <option *ngFor="let g of generos" [value]="g.value">{{g.label}}</option>
          </select>
        </div>
      </div>

      <div class="section-title-bar">Anexos</div>
      <div class="form-row">
        <div class="form-group third">
          <label>Tipo de Documento</label>
          <select class="form-select" [(ngModel)]="docTipo" name="docTipo">
            <option value="">Selecione</option>
            <option *ngFor="let t of docTipos" [value]="t">{{t}}</option>
          </select>
        </div>
        <div class="form-group third">
          <label>Arquivo</label>
          <input type="file" (change)="onFileSelected($event)">
        </div>
        <div class="form-group third"></div>
      </div>

      <div class="attachments">
        <table class="attachments-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Arquivo</th>
              <th>Tamanho</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let a of anexos; let i = index">
              <td>{{a.tipo}}</td>
              <td>{{a.nome}}</td>
              <td>{{(a.size/1024) | number:'1.0-0'}} KB</td>
              <td class="file-actions">
                <button type="button" class="btn-secondary" (click)="baixarAnexo(i)">Baixar</button>
                <button type="button" class="btn-danger" (click)="removerAnexo(i)">Remover</button>
              </td>
            </tr>
            <tr *ngIf="anexos.length===0"><td colspan="4" class="empty">Nenhum anexo adicionado</td></tr>
          </tbody>
        </table>
      </div>

      <div class="form-actions" style="display: flex; align-items: flex-end;">
        <div *ngIf="form.tipoMotivo==='A'" style="flex: 1; max-width: 350px; margin-right: 24px;">
          <label style="font-weight: 500;">Observa√ß√µes da Solicita√ß√£o</label>
          <textarea [(ngModel)]="form.observacoesSolicitacao" name="observacoesSolicitacao" rows="2" placeholder="Digite observa√ß√µes relevantes..." style="width: 100%; resize: vertical;"></textarea>
        </div>
        <div style="margin-left: auto; display: flex; gap: 12px; align-items: flex-end;">
          <button type="submit" class="btn-primary" [disabled]="loading">
            <span *ngIf="!loading">üíæ Salvar Benefici√°rio</span>
            <span *ngIf="loading">‚è≥ Salvando...</span>
          </button>
          <button type="button" class="btn-secondary" (click)="limparForm()" [disabled]="loading">
            üóëÔ∏è Limpar Formul√°rio
          </button>
          <button type="button" class="btn-secondary" (click)="voltarParaBeneficiarios()">
            ‚Üê Voltar para Lista
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
      
