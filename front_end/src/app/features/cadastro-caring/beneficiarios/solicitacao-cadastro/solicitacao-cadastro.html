<app-page-header 
  [title]="'Cadastro Caring ‚Äî Solicita√ß√µes da Empresa'" 
  [subtitle]="'Acompanhe as solicita√ß√µes, ajuste pend√™ncias e anexe documentos'" 
  [icon]="'users'">
</app-page-header>

<!-- Informa√ß√µes da Empresa -->
<div class="empresa-info" *ngIf="empresaSelecionada">
  <div class="empresa-card">
    <div class="empresa-icon">üè¢</div>
    <div class="empresa-details">
      <h3>{{empresaSelecionada.nome}}</h3>
      <p>CNPJ: {{empresaSelecionada.cnpj}}</p>
      <span class="empresa-codigo">C√≥digo: {{empresaSelecionada.codigoEmpresa}}</span>
    </div>
  </div>
</div>

<div class="solicitacao-container">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-message caring-card">
    <div class="spinner"></div>
    <span>Carregando solicita√ß√µes...</span>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && minhasSolicitacoes.length === 0" class="empty-state caring-card">
    <div class="empty-icon">üìã</div>
    <h3>Voc√™ n√£o possui solicita√ß√µes</h3>
    <p>Envie novas solicita√ß√µes nas telas de Inclus√£o, Altera√ß√£o ou Exclus√£o de Benefici√°rios.</p>
  </div>

  <!-- Tabela de Solicita√ß√µes (exibir mesmo durante loading se h√° dados em cache) -->
  <div class="table-wrapper caring-card" *ngIf="minhasSolicitacoes.length > 0">
    <div class="table-header">
      <h3>Suas Solicita√ß√µes ({{minhasSolicitacoes.length}})</h3>
      <button class="btn btn-secondary btn-sm" (click)="carregarSolicitacoes()">
        üîÑ Atualizar
      </button>
    </div>
    
    <table class="table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Tipo</th>
          <th>Nome do Benefici√°rio</th>
          <th>CPF</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of minhasSolicitacoes">
          <td>{{ s.data | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>
            <span class="tipo-badge" [class]="'tipo-' + s.tipo">
              {{ s.tipo === 'inclusao' ? '‚ûï Inclus√£o' : 
                 s.tipo === 'alteracao' ? '‚úèÔ∏è Altera√ß√£o' : 
                 '‚ùå Exclus√£o' }}
            </span>
          </td>
          <td>{{ s.descricao }}</td>
          <td>{{ s.identificador }}</td>
          <td>
            <span class="status-badge" [class]="'status-' + s.status">
              {{ s.status === 'pendente' ? '‚è≥ Pendente' : 
                 s.status === 'aguardando' ? '‚ö†Ô∏è Aguardando Ajustes' : 
                 '‚úÖ Conclu√≠da' }}
            </span>
          </td>
          <td class="actions">
            <button class="btn btn-primary btn-sm" title="Ver Detalhes" (click)="openDetails(s)">
              üëÅÔ∏è Detalhes
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="showDetails" class="modal-backdrop" (click)="closeDetails()"></div>
  <div *ngIf="showDetails" class="modal-card" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalhes da Solicita√ß√£o</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        
        <button class="btn btn-icon" *ngIf="selected?.tipo === 'inclusao'" title="Ver dados da inclus√£o" (click)="openInclusaoDetails()">üîé</button>
        <button class="modal-close" (click)="closeDetails()">√ó</button>
      </div>
    </div>
    <div class="modal-body" *ngIf="selected as d">
      <div class="detail-grid">
        <div class="item"><span class="label">Data:</span><span class="value">{{ d.data | date:'dd/MM/yyyy HH:mm' }}</span></div>
        <div class="item"><span class="label">Tipo:</span><span class="value">{{ d.tipo }}</span></div>
        <div class="item"><span class="label">Identificador:</span><span class="value">{{ d.identificador }}</span></div>
        <div class="item wide"><span class="label">Descri√ß√£o:</span><span class="value">{{ d.descricao }}</span></div>
      </div>

    <div class="section-subtitle">Hist√≥rico</div>
    <div class="history-list">
      <div class="history-item" *ngFor="let h of historicoCompleto">
        <span class="history-date">{{ h.dataOperacao | date:'dd/MM/yyyy HH:mm' }}</span>
        <span class="history-status">{{ h.usuarioNome }}</span>
        <span class="history-observacao">‚Äî {{ h.valorNovo }}</span>
      </div>
    </div>
    <div class="history-list" *ngIf="historicoCompleto.length === 0">
      <div class="history-item">
        <span class="history-status">Sem hist√≥rico dispon√≠vel</span>
      </div>
    </div>

    

      <div *ngIf="d.status === 'concluida'" class="blocked-msg">
        <i class="icon-lock"></i>
        <div>
          <div class="blocked-title">Solicita√ß√£o conclu√≠da</div>
          <div class="blocked-text">N√£o √© poss√≠vel alterar uma solicita√ß√£o que j√° foi aceita.</div>
        </div>
      </div>

      <div *ngIf="shouldShowAjustes(d)" class="ajustes-section">
        <div class="section-title-bar">Ajustes do solicitante</div>
        <div class="form-row">
          <div class="form-group full">
            <label>Mensagem ao aprovador</label>
            <textarea class="input" rows="3" [(ngModel)]="ajustes[d.id].mensagem" placeholder="Explique as corre√ß√µes realizadas ou informa√ß√µes adicionais"></textarea>
          </div>
        </div>

        <div class="section-subtitle">Anexar documentos complementares</div>
        <div class="form-row">
          <div class="form-group third">
            <label>Tipo do documento</label>
            <select class="form-select" [(ngModel)]="ajustes[d.id].docTipo">
              <option value="">Selecione</option>
              <option value="RG">RG</option>
              <option value="CPF">CPF</option>
              <option value="Comprovante">Comprovante</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          <div class="form-group third">
            <label>Arquivo</label>
            <input type="file" class="input" (change)="onFileSelected(d, $event)">
          </div>
          <div class="form-group third actions-right">
            <label>&nbsp;</label>
            <button class="btn btn-primary btn-sm" (click)="salvarAjustesSelecionado()"><i class="icon-upload"></i> Enviar ajustes</button>
          </div>
        </div>

        <div class="anexos-list" *ngIf="ajustes[d.id].anexos.length > 0">
          <div class="section-subtitle">Documentos anexados</div>
          <div class="anexo" *ngFor="let a of ajustes[d.id].anexos; let i = index">
            <div class="anexo-info">
              <span class="tipo">{{ a.tipo }}</span>
              <span class="nome">{{ a.nome }}</span>
              <span class="size">{{ a.size / 1024 | number:'1.0-1' }} KB</span>
            </div>
            <div class="anexo-actions">
              <button class="btn btn-secondary btn-sm" (click)="baixarAnexo(d, i)"><i class="icon-download"></i> Baixar</button>
              <button class="btn btn-secondary btn-sm" (click)="removerAnexo(d, i)"><i class="icon-trash"></i> Remover</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary btn-sm" (click)="closeDetails()"><i class="icon-x"></i> Fechar</button>
      <button *ngIf="selected && selected.status === 'aguardando'" class="btn btn-primary btn-sm" (click)="corrigirSolicitacao(selected)">
        <i class="icon-edit"></i> Corrigir e Reenviar
      </button>
    </div>
  </div>
</div>

<div *ngIf="showBenefDetails" class="modal-backdrop" (click)="closeBenefDetails()"></div>
<div *ngIf="showBenefDetails" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Detalhes do Benefici√°rio</h3>
    <button class="modal-close" (click)="closeBenefDetails()">√ó</button>
  </div>
  <div class="modal-body" *ngIf="benefDetalhes as r">
    <div class="detail-grid">
      <div class="item"><span class="label">Nome:</span><span class="value">{{ r.nome }}</span></div>
      <div class="item"><span class="label">CPF:</span><span class="value">{{ r.cpf }}</span></div>
      <div class="item"><span class="label">Nascimento:</span><span class="value">{{ r.nascimento }}</span></div>
      <div class="item"><span class="label">Status:</span><span class="value">{{ r.benStatus }}</span></div>
      <div class="item"><span class="label">Matr√≠cula:</span><span class="value">{{ r.matricula }}</span></div>
      <div class="item"><span class="label">Endere√ßo:</span><span class="value">{{ r.endereco }}</span></div>
      <div class="item"><span class="label">N√∫mero:</span><span class="value">{{ r.numero }}</span></div>
      <div class="item"><span class="label">Complemento:</span><span class="value">{{ r.complemento }}</span></div>
      <div class="item"><span class="label">Bairro:</span><span class="value">{{ r.bairro }}</span></div>
      <div class="item"><span class="label">CEP:</span><span class="value">{{ r.cep }}</span></div>
      <div class="item"><span class="label">Celular:</span><span class="value">{{ r.celular }}</span></div>
      <div class="item"><span class="label">E-mail:</span><span class="value">{{ r.email }}</span></div>
      <div class="item"><span class="label">Plano:</span><span class="value">{{ r.planoProd }}</span></div>
      <div class="item"><span class="label">Admiss√£o:</span><span class="value">{{ r.admissao }}</span></div>
      <div class="item"><span class="label">C√≥digo Unimed Seg:</span><span class="value">{{ r.benCodUnimedSeg }}</span></div>
      <div class="item"><span class="label">C√≥digo do Cart√£o:</span><span class="value">{{ r.benCodCartao }}</span></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="closeBenefDetails()">Fechar</button>
  </div>
  
</div>

<div *ngIf="showInclusaoDetails" class="modal-backdrop" (click)="closeInclusaoDetails()"></div>
<div *ngIf="showInclusaoDetails" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Detalhes da Inclus√£o</h3>
    <button class="modal-close" (click)="closeInclusaoDetails()">√ó</button>
  </div>
  <div class="modal-body">
    <div class="detail-grid" *ngIf="dadosDetalhes as d">
      <div class="item"><span class="label">Rela√ß√£o Dep.:</span><span class="value">{{ d.benRelacaoDep }}</span></div>
      <div class="item" *ngIf="d.benRelacaoDep === '00'"><span class="label">Titular:</span><span class="value">{{ d.benCpf }}</span></div>
      <div class="item" *ngIf="d.benRelacaoDep !== '00'"><span class="label">Titular:</span><span class="value">{{ d.benTitularCpf }}</span></div>
      <div class="item"><span class="label">Nome:</span><span class="value">{{ d.benNomeSegurado }}</span></div>
      <div class="item" *ngIf="d.benTitularId"><span class="label">ID Titular:</span><span class="value">{{ d.benTitularId }}</span></div>
      <div class="item"><span class="label">CPF:</span><span class="value">{{ d.benCpf }}</span></div>
      <div class="item"><span class="label">Nascimento:</span><span class="value">{{ d.benDtaNasc }}</span></div>
      <div class="item"><span class="label">Sexo:</span><span class="value">{{ d.benSexo }}</span></div>
      <div class="item"><span class="label">M√£e:</span><span class="value">{{ d.benNomeDaMae }}</span></div>
      <div class="item"><span class="label">Endere√ßo:</span><span class="value">{{ d.benEndereco }}</span></div>
      <div class="item"><span class="label">N√∫mero:</span><span class="value">{{ d.benNumero }}</span></div>
      <div class="item"><span class="label">Bairro:</span><span class="value">{{ d.benBairro }}</span></div>
      <div class="item"><span class="label">CEP:</span><span class="value">{{ d.benCep }}</span></div>
      <div class="item"><span class="label">Cidade/UF:</span><span class="value">{{ d.benCidade }} / {{ d.benUf }}</span></div>
      <div class="item"><span class="label">Matr√≠cula:</span><span class="value">{{ d.benMatricula }}</span></div>
      <div class="item"><span class="label">E-mail:</span><span class="value">{{ d.benEmail }}</span></div>
      <div class="item"><span class="label">Celular:</span><span class="value">{{ d.benDddCel }}</span></div>
      <div class="item"><span class="label">Plano:</span><span class="value">{{ d.benPlanoProd }}</span></div>
      <div class="item"><span class="label">Admiss√£o:</span><span class="value">{{ d.benAdmissao }}</span></div>
      <div class="item"><span class="label">Data Inclus√£o:</span><span class="value">{{ d.benDtaInclusao }}</span></div>
      <div class="item"><span class="label">Status:</span><span class="value">{{ d.benStatus }}</span></div>
      <div class="item"><span class="label">C√≥digo do Cart√£o:</span><span class="value">{{ d.benCodCartao }}</span></div>
      <div class="item"><span class="label">C√≥digo Unimed Seg:</span><span class="value">{{ d.benCodUnimedSeg }}</span></div>
      <div class="item"><span class="label">C√≥digo da Carterinha:</span><span class="value">{{ (d.benCodUnimedSeg || '') + (d.benCodCartao || '') }}</span></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="closeInclusaoDetails()">Fechar</button>
  </div>
</div>
