<app-page-header 
  [title]="'Cadastro Caring ‚Äî Altera√ß√£o Cadastral'" 
  [subtitle]="'Filtre o benefici√°rio e abra detalhes para alterar'" 
  [icon]="'users'">
</app-page-header>

<!-- Informa√ß√µes da Empresa -->
<div class="empresa-info" *ngIf="empresaSelecionada">
  <div class="empresa-card">
    <div class="empresa-icon">üè¢</div>
    <div class="empresa-details">
      <h3>{{ empresaSelecionada.nome || empresaSelecionada.razaoSocial || empresaSelecionada.fantasia }}</h3>
      <p>CNPJ: {{empresaSelecionada.cnpj}}</p>
      <span class="empresa-codigo">C√≥digo: {{empresaSelecionada.codigoEmpresa}}</span>
    </div>
  </div>
  
</div>

<div class="filters-section">
  <div class="filters-container caring-card">
    <div class="search-group">
      <i class="icon-search"></i>
      <input type="text" class="input" [(ngModel)]="nome" placeholder="Pesquisar por nome" />
    </div>
    <ui-input [(ngModel)]="cpf" name="cpf" placeholder="000.000.000-00" [onlyDigits]="true" [maxlength]="11"></ui-input>
    <button class="btn btn-primary" (click)="pesquisar()" [disabled]="loading">Pesquisar</button>
    <button class="btn btn-secondary" (click)="limparFiltros()" [disabled]="loading">Limpar</button>
  </div>
 
  <!-- Indicadores de Loading e Erro -->
  <div class="status-container" *ngIf="loading || error">
    <div class="loading-indicator" *ngIf="loading">
      <div class="spinner"></div>
      <span>Carregando benefici√°rios...</span>
    </div>
    <div class="error-message" *ngIf="error">
      <span class="error-icon">‚ö†Ô∏è</span>
      <span>{{ error }}</span>
      <button class="btn-retry" (click)="carregarBeneficiarios()">üîÅ Tentar novamente</button>
    </div>
  </div>

  <div class="caring-card table-wrapper">
    <table class="table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>CPF</th>
          <th>Nascim.</th>
          <th>Data Inclus√£o</th>
          <th>Data Exclus√£o</th>
          <th>Tipo Depend√™ncia</th>
          <th>Acomoda√ß√£o</th>
          <th>Matr√≠cula</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of paged">
          <td>{{row.nome}}</td>
          <td>{{row.cpf}}</td>
          <td>{{row.nascimento}}</td>
          <td>{{formatDateBR(row.data_inclusao)}}</td>
          <td>{{row.data_exclusao ? formatDateBR(row.data_exclusao) : ''}}</td>
          <td>{{row.tipo_dependencia}}</td>
          <td>{{row.acomodacao}}</td>
          <td>{{row.matricula_beneficiario}}</td>
          <td>{{statusOf(row)}}</td>
          <td class="actions">
            <button class="btn-icon" (click)="openDetails(row)" title="Detalhes">üîé</button>
          </td>
        </tr>
        <tr *ngIf="paged.length === 0 && !loading">
          <td colspan="10" class="empty">
            <span *ngIf="!nome && !cpf">Nenhum benefici√°rio cadastrado.</span>
            <span *ngIf="nome || cpf">Nenhum benefici√°rio encontrado com os filtros aplicados.</span>
          </td>
        </tr>
        <tr *ngIf="loading">
          <td colspan="10" class="loading-row">
            <div class="loading-text">
              <div class="spinner-small"></div>
              Carregando...
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Contador de resultados -->
    <div class="results-info" *ngIf="!loading && data.length > 0">
      <span>Exibindo {{ paged.length }} de {{ filtered.length }} benefici√°rios (total: {{ data.length }})</span>
    </div>

    <div class="pagination" *ngIf="!loading && totalPages > 1">
      <button (click)="goTo(1)">¬´¬´</button>
      <button (click)="goTo(page - 1)">¬´</button>
      <span class="pages">
        <button *ngFor="let p of [].constructor(totalPages); let i = index" [class.active]="page === i + 1" (click)="goTo(i + 1)">{{i + 1}}</button>
      </span>
      <button (click)="goTo(page + 1)">¬ª</button>
      <button (click)="goTo(totalPages)">¬ª¬ª</button>
    </div>
  </div>
</div>

<!-- Card de Detalhes -->
<div *ngIf="showDetails" class="modal-backdrop" (click)="closeDetails()"></div>
<div *ngIf="showDetails" class="modal-card">
  <div class="modal-header">
    <h3>Dados do Benefici√°rio</h3>
    <button class="modal-close" (click)="closeDetails()">√ó</button>
  </div>
  <div class="modal-body">
    <div class="detail-grid" *ngIf="selectedRow as r">
      <div class="item"><span class="label">Nome:</span><span class="value">{{r.nome}}</span></div>
      <div class="item"><span class="label">CPF:</span><span class="value">{{r.cpf}}</span></div>
      <div class="item"><span class="label">Nascimento:</span><span class="value">{{r.nascimento}}</span></div>
      <div class="item"><span class="label">Inclus√£o:</span><span class="value">{{formatDateBR(r.data_inclusao)}}</span></div>
      <div class="item"><span class="label">Nome da M√£e:</span><span class="value">{{r.nomeMae || '‚Äî'}}</span></div>
      <div class="item"><span class="label">Exclus√£o:</span><span class="value">{{r.data_exclusao ? formatDateBR(r.data_exclusao) : '‚Äî'}}</span></div>
      <div class="item"><span class="label">Tipo Depend√™ncia:</span><span class="value">{{labelRelacaoDep(r)}}</span></div>
      <div class="item"><span class="label">Acomoda√ß√£o:</span><span class="value">{{r.acomodacao}}</span></div>
      <div class="item"><span class="label">Matr√≠cula:</span><span class="value">{{r.matricula_beneficiario}}</span></div>
      <div class="item"><span class="label">C√≥d. Carterinha:</span><span class="value">{{ (r.codigo_carterinha || ((r.benCodUnimedSeg || '') + (r.benCodCartao || ''))) || '‚Äî' }}</span></div>
      <div class="item"><span class="label">Status:</span><span class="value">{{statusOf(r)}}</span></div>
      <div class="item"><span class="label">Nome Titular:</span><span class="value">{{r.nomeTitular || '‚Äî'}}</span></div>
      <div class="item"><span class="label">Admiss√£o:</span><span class="value">{{r.admissao || '‚Äî'}}</span></div>
    </div>

    <div class="section-subtitle">Endere√ßo</div>
    <div class="detail-grid" *ngIf="selectedRow as r">
      <div class="item"><span class="label">Endere√ßo:</span><span class="value">{{r.endereco || '‚Äî'}}</span></div>
      <div class="item"><span class="label">N√∫mero:</span><span class="value">{{r.numero || '‚Äî'}}</span></div>
      <div class="item"><span class="label">Complemento:</span><span class="value">{{r.complemento || '‚Äî'}}</span></div>
      <div class="item"><span class="label">Bairro:</span><span class="value">{{r.bairro || '‚Äî'}}</span></div>
      <div class="item"><span class="label">CEP:</span><span class="value">{{r.cep || '‚Äî'}}</span></div>
    </div>

    <div class="section-subtitle">Contato</div>
    <div class="detail-grid" *ngIf="selectedRow as r">
      <div class="item"><span class="label">Celular (com DDD):</span><span class="value">{{ formatarCelular(r.celular) }}</span></div>
      <div class="item"><span class="label">E-mail:</span><span class="value">{{r.email || '‚Äî'}}</span></div>
    </div>

    <div class="section-subtitle">Dados Complementares</div>
    <div class="detail-grid" *ngIf="selectedRow as r">
      <div class="item"><span class="label">Identidade de G√™nero:</span><span class="value">{{r.identidadeGenero || '‚Äî'}}</span></div>
      <div class="item"><span class="label">Nome Social:</span><span class="value">{{r.nomeSocial || '‚Äî'}}</span></div>
      <div class="item"><span class="label">Indicador Pessoa Trans:</span><span class="value">{{r.indicadorPessoaTrans || r.indicador_pessoa_trans || '‚Äî'}}</span></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn-secondary" (click)="openExclusao()" [disabled]="!canOpenExclusao(selectedRow)">Exclus√£o</button>
    <button class="btn-primary" (click)="goAlteracaoFromDetails()">Altera√ß√£o de Cadastro</button>
    <button class="btn-info" (click)="gerarCarterinha()">Gerar Carterinha Virtual</button>
  </div>
</div>

<!-- Card de Exclus√£o -->
<div *ngIf="showExclusao" class="modal-backdrop" (click)="closeExclusao()"></div>
<div *ngIf="showExclusao" class="modal-card">
  <div class="modal-header">
    <h3>Exclus√£o de Benefici√°rio</h3>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="btn btn-icon" title="Ver benefici√°rio" (click)="openBenefDetailsExclusao()">üîé</button>
      <button class="modal-close" (click)="closeExclusao()">√ó</button>
    </div>
  </div>
  <div class="modal-body">
    <div class="exclusion-grid">
      <div class="detail-grid" *ngIf="selectedRow">
        <div class="item"><span class="label">C√≥d. Carterinha:</span><span class="value">{{ selectedRow.codigo_carterinha || ((selectedRow.benCodUnimedSeg || '') + (selectedRow.benCodCartao || '')) || '‚Äî' }}</span></div>
      </div>
      <div class="field">
        <label>Motivo</label>
        <select [(ngModel)]="exMotivo" name="ex_motivo" class="select-md">
          <option value="">Selecione</option>
          <option value="rescisao">Rescis√£o</option>
          <option value="falecimento">Falecimento</option>
          <option value="transferencia">Transfer√™ncia</option>
          <option value="outro">Outro</option>
        </select>
      </div>
      <div class="field">
        <label>Data da Exclus√£o</label>
        <ui-input type="date" [(ngModel)]="exData" name="ex_data" [min]="minDate" (valueChange)="onExDateChange($event)"></ui-input>
        <div class="error-card" *ngIf="dateError">{{dateError}}</div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn-secondary" (click)="closeExclusao()">Cancelar</button>
    <button class="btn-primary" (click)="confirmarExclusao()">Confirmar Exclus√£o</button>
  </div>


<!-- Card de Carterinha Virtual (fora de qualquer outro modal) -->
</div>
<div *ngIf="showBenefDetails" class="modal-backdrop" (click)="closeBenefDetails()"></div>
<div *ngIf="showBenefDetails" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Detalhes do Benefici√°rio</h3>
    <button class="modal-close" (click)="closeBenefDetails()">√ó</button>
  </div>
  <div class="modal-body" *ngIf="benefDetalhes as r">
    <div class="detail-grid">
      <div class="item"><span class="label">Nome:</span><span class="value">{{ r.nome }}</span></div>
      <div class="item"><span class="label">CPF:</span><span class="value">{{ r.cpf }}</span></div>
      <div class="item"><span class="label">Nascimento:</span><span class="value">{{ r.nascimento }}</span></div>
      <div class="item"><span class="label">Status:</span><span class="value">{{ r.benStatus }}</span></div>
      <div class="item"><span class="label">Matr√≠cula:</span><span class="value">{{ r.matricula }}</span></div>
      <div class="item"><span class="label">Endere√ßo:</span><span class="value">{{ r.endereco }}</span></div>
      <div class="item"><span class="label">N√∫mero:</span><span class="value">{{ r.numero }}</span></div>
      <div class="item"><span class="label">Complemento:</span><span class="value">{{ r.complemento }}</span></div>
      <div class="item"><span class="label">Bairro:</span><span class="value">{{ r.bairro }}</span></div>
      <div class="item"><span class="label">CEP:</span><span class="value">{{ r.cep }}</span></div>
      <div class="item"><span class="label">Celular:</span><span class="value">{{ r.celular }}</span></div>
      <div class="item"><span class="label">E-mail:</span><span class="value">{{ r.email }}</span></div>
      <div class="item"><span class="label">Plano:</span><span class="value">{{ r.planoProd }}</span></div>
      <div class="item"><span class="label">Admiss√£o:</span><span class="value">{{ r.admissao }}</span></div>
      <div class="item"><span class="label">C√≥digo Unimed Seg:</span><span class="value">{{ r.benCodUnimedSeg }}</span></div>
      <div class="item"><span class="label">C√≥digo do Cart√£o:</span><span class="value">{{ r.benCodCartao }}</span></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="closeBenefDetails()">Fechar</button>
  </div>
</div>
<div *ngIf="showCarterinha" class="modal-backdrop" (click)="closeCarterinha()"></div>
<div *ngIf="showCarterinha" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>Gerar Carterinha Virtual</h3>
    <button class="modal-close" (click)="closeCarterinha()">√ó</button>
  </div>
  <div class="modal-body">
    <div class="exclusion-grid">
      <div class="field">
        <label>Nome</label>
        <ui-input [(ngModel)]="cardNome" name="card_nome"></ui-input>
      </div>
      <div class="field">
        <label>CPF</label>
        <ui-input [(ngModel)]="cardCpf" name="card_cpf" placeholder="000.000.000-00"></ui-input>
      </div>
      <div class="field">
        <label>C√≥digo da Carterinha</label>
        <ui-input [(ngModel)]="cardCodigo" name="card_codigo"></ui-input>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn-secondary" (click)="closeCarterinha()">Cancelar</button>
    <button class="btn-primary" (click)="abrirCartaoVirtual()">Abrir Cart√£o Virtual</button>
  </div>
</div>

<div *ngIf="showSolicConfirm" class="modal-backdrop" (click)="closeSolicConfirm()"></div>
<div *ngIf="showSolicConfirm" class="modal-card" (click)="$event.stopPropagation()">
  <div class="modal-header">
    <h3>{{ confirmTitle || 'Solicita√ß√£o criada' }}</h3>
    <button class="modal-close" (click)="closeSolicConfirm()">√ó</button>
  </div>
  <div class="modal-body">
    <div class="detail-grid">
      <div class="item wide"><span class="label">Mensagem:</span><span class="value">{{ confirmMessage }}</span></div>
      <div class="item" *ngIf="confirmNumber"><span class="label">N√∫mero:</span><span class="value">{{ confirmNumber }}</span></div>
      <div class="item" *ngIf="confirmCardCode"><span class="label">C√≥d. Carterinha:</span><span class="value">{{ confirmCardCode }}</span></div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary btn-sm" (click)="closeSolicConfirm()">OK</button>
  </div>
</div>
